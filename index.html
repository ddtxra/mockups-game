<script src="feature-viewer.nextprot.js"></script>

<style type="text/css">
    #container {
        overflow-y: scroll;
        max-height: 1050px;
        border-width: 1px;
        border-color: grey;
        border-style: solid;
        width: 1680px;
        margin: 10px;
    }
    
    .svgHeader {
        display: none;
    }
    
    select {
        margin: 10px;
    }
    
    table {
        margin: 10px;
    }
    
    table tr td {
        border-width: 1px;
        border-color: grey;
        border-style: solid;
    }
</style>

<body>
      <div style="display:none">
        <div><label>small-intron must be smaller than </label><input id="small-intron" type="number"></div>
        <button>Normalize</button>
      </div>
    <div>
        <h3>Notes</h3>
        <ul>
            <li>If there is more than one transcript for a gene, we still need to choose the transcript</li>
            <li>Real exon length can be found in <a target="_blank" href="data/data.json">here</a></li>
            <li>Normalization paramaters can only be adjusted in this javascript code for now. We will add some input boxes so we can play with different normalization parameters to find a better fit for the game</li>
            <li>SNP variant is still missing</li>
            <li>Up / Down / Obstacles are not yet defined (not sure if we should provide this info or we leave it up to you)....</li>
            <li>Intron are much bigger than exons in reality (if possible in the drawing we could show le brin enroul√© pour paraitre plus grand...</li>
            <li>There is not a hole below the start and stop codon (it should be one exon with different color) from exon to utr (untranslated region)</li>
            <li>Wait 10 seconds to see the results below...</li>
        </ul>
    </div>
    <div id="container">
      <div id="genes" style="width:1680px;height:1050px;padding:5px"></div>
    </div>
</body>



<script>
    loadProtein()

    function getBaseLog(x, y) {
        return Math.log(y) / Math.log(x);
    }
    
    function normalizeLength(levelData){
        
        if (levelData.type === "intron") {
            var normalizedIntron = getNormalizedLengthForIntrons(levelData.realLength);
            levelData.class = normalizedIntron.class
            levelData.normalizedLength = normalizedIntron.normalizedLength
        } else {
            var normalized = getNormalizedLengthForNonIntron(levelData.realLength);
            levelData.normalizedLength = normalized.normalizedLength
        }
        
    }

    function getNormalizedLengthForNonIntron(realLength) {

        //Based on histogram in R
        //hist(log(exons$V6), breaks=5, col="lightgreen")
        var continousNormalization = Math.round(realLength / 5);
        if (continousNormalization > 100) {
            continousNormalization = 100;
        }
        if (continousNormalization < 1) {
            continousNormalization = 1;
        }

        return { normalizedLength: continousNormalization }

    };

    function getNormalizedLengthForIntrons(number) {

        //Based on histogram in R
        //hist(log(exons$V6), breaks=5, col="lightgreen")
        if (number < 5000)
            return {
                class: "small-intron: The avatar can easily jump",
                normalizedLength: 1
            } //simple jump --> most of them end up in this category
        if (number < 10000)
            return {
                class: "medium-intron: need an easy spliceosome, can be small 1,2 rocks that needs to jump",
                normalizedLength: 5
            } //mutiple jumps (kind of rocks) 
        if (number < 15000)
            return {
                class: "large-intron: need a more complicated spliceosome",
                normalizedLength: 10
            } //spliceosome
        if (number < 20000)
            return {
                class: "big-intron: need a difficult spliceosome",
                normalizedLength: 20
            } //Complicated spliceosome
        return {
            class: "huge-intron: we need a SR protein before, like a catapult",
            normalizedLength: 100
        } //SR protein (Catapult)
    };
    

    function renderGenes(genes) {

        //Normalization and get max
        var maxNormalizedLength = 0;
        var minNormalizedLength = Number.MAX_SAFE_INTEGER;
        genes.forEach(function (gene) {
            gene.totalNormalizedLength = 0
            gene.levelData.forEach(function (ld) {
                normalizeLength(ld);
                gene.totalNormalizedLength += ld.normalizedLength
            })
            maxNormalizedLength = Math.max(maxNormalizedLength, gene.totalNormalizedLength)
            minNormalizedLength = Math.min(maxNormalizedLength, gene.totalNormalizedLength)

        })
        
        console.log("Max normalized length: " + maxNormalizedLength)
        console.log("Min normalized length: " + minNormalizedLength)
            
        genes.forEach(function (gene) {

        
            $("#genes").append("<p style='font-size:12px'>" + 
                               "<br>Gene name: " + gene.geneName + " (links to neXtProt and UniProt)" +
                               "<br>Transcript: <a target='_blank' href='http://www.ensembl.org/Homo_sapiens/transview?db=core;transcript=" + gene.transcript + "'>" + gene.transcript + "</a>"+
                               "<br>Chromosome: " + gene.chromosome + 
                               "<br>Exons: " + gene.exonsCount + 
                               "<br>???% of protein coding (exons)" +
                               "<br>" + gene.geneLength + "bp   " + 
                               "<br>" + gene.totalNormalizedLength + "units "+ 
                               "<br>" + Math.ceil((gene.exonsLength + 1) / 3.0)  + "~aa (exonsLength / 3) but seems not to be correct" +
                               "<br>Text: This gene is responsible for bla bla bla ...." +
                               "</p>JSON:"
                              )
            
            $("#genes").append("<p style='font-size:8px'>" + JSON.stringify(gene, null, 2) + "</p>")
            $("#genes").append("<div id=\'" + gene.id + "\'></div>")
            $("#genes").append("<hr>")

            //Create a new Feature Viewer and add some rendering options
            var ft = new FeatureViewer(maxNormalizedLength, "#" + gene.id, {
                showAxis: true,
                showSequence: true,
                brushActive: true,
                toolbar: true,
                bubbleHelp: true,
                zoomMax: 10
            });

            var exonData = [];
            var intronData = [];
            var starsData = [];

            var cursor = 0;
            gene.levelData.forEach(function (ld) {
                
                var desc = ld.class ? ld.class : "" + "\n normalizedLength:" + ld.normalizedLength + "\n realLength:" + ld.realLength;
                var normalizedLength = ld.normalizedLength;
                if (ld.type === "exon" || ld.type === "utr") {
                    exonData.push({
                        "x": cursor,
                        "y": cursor + normalizedLength,
                        "description": desc,
                        "color": (ld.type == "exon") ? "green" : "lightgreen"
                    })
                } else if (ld.type === "intron") {
                    intronData.push({
                        "x": cursor,
                        "y": cursor + normalizedLength,
                        "description": desc,
                        "color": "blue"
                    })
                } else if (ld.type === "start_codon" || ld.type === "stop_codon" || ld.type === "snp") {
                    starsData.push({
                        "x": cursor,
                        "y": cursor + normalizedLength,
                        "description": desc,
                        "color": (ld.type == "snp") ? "red" : "orange",
                        "description": ld.type
                    })

                }
                cursor += normalizedLength
            })

            //Add some features
            ft.addFeature({
                data: starsData,
                name: "stars",
                type: "rect"
            });

            //Add some features
            ft.addFeature({
                data: exonData,
                name: "exons",
                type: "rect"
            });

            //Add some features
            ft.addFeature({
                data: intronData,
                name: "introns",
                type: "rect"
            });

        })


    }

    function loadProtein() {
        $.getJSON('data/data.json', function (genes) {
            renderGenes(genes);
        })
    }
</script>