<script src="https://cdn.rawgit.com/calipho-sib/feature-viewer/v1.0.0/dist/feature-viewer.nextprot.js"></script>

<style type="text/css">
    #container {
        overflow-y: scroll;
        max-height: 1050px;
        border-width: 1px;
        border-color: grey;
        border-style: solid;
        width: 1680px;
        margin: 10px;
    }
    
    .svgHeader {
        display: none;
    }

    select {
        margin: 10px;
    }

    table {
        margin: 10px;
    }

    table tr td {
        border-width: 1px;
        border-color: grey;
        border-style: solid;
    }
</style>

<body>
    <div id="container">
        <div id="genes" style="width:1680px;height:1050px"></div>
    </div>
</body>



<script>
    
    loadProtein()
    function getBaseLog(x, y) {
        return Math.log(y) / Math.log(x);
    }

    function renderGenes(genes) {
        
            genes.forEach(function (gene) {

                    $("#genes").append("<p>Gene name:" + gene.geneName + "Transcript: " +  gene.transcript + " Exons:" + gene.exonsCount  +"</p>")
                    $("#genes").append("<p style='font-size:8px'>" + JSON.stringify(gene, null, 2) + "</p>")
                    $("#genes").append("<div id=\'" + gene.id  +"\'></div>")

                    //Create a new Feature Viewer and add some rendering options
                    var ft = new FeatureViewer(800, "#" + gene.id, {
                        showAxis: true,
                        showSequence: true,
                        brushActive: true,
                        toolbar: true,
                        bubbleHelp: true,
                        zoomMax: 10
                    });
                
                    console.log(gene)

                    var exonData = [];
                    var intronData = [];
                    var starsData = [];

                    var cursor = 0;
                    gene.levelData.forEach(function (ld){
                        var len = ld.normalizedLength;
                        if(ld.type === "exon" || ld.type === "utr") {
                            exonData.push({
                                "x": cursor,
                                "y": cursor+ len,
                                "description" : ld.class,
                                "color" : (ld.type == "exon") ? "green" : "blue"
                            })
                        }else if(ld.type === "intron") {
                            intronData.push({
                                "x": cursor,
                                "y": cursor+ len,
                                "description" : ld.class,
                                "color" : "red"
                            })
                        }else if(ld.type === "start_codon" || ld.type === "stop_codon") {
                            starsData.push({
                                "x": cursor,
                                "y": cursor+ len,
                                "description" : ld.class,
                                "color" : "orange",
                                "description" : ld.type
                            })
                        }
                        cursor += len
                    })

                    //Add some features
                    ft.addFeature({
                        data: starsData,
                        name: "stars",
                        type: "rect"
                    });
                    
                    //Add some features
                    ft.addFeature({
                        data: exonData,
                        name: "exons",
                        type: "rect"
                    });

                    //Add some features
                    ft.addFeature({
                        data: intronData,
                        name: "introns",
                        type: "rect"
                    });

            })


    }

    function loadProtein() {
        $.getJSON('processing-tsv/data.json', function(genes) {
            renderGenes(genes);
        })
    }
    </script>