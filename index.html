<script src="feature-viewer.nextprot.js"></script>

<style type="text/css">
    #container {
        overflow-y: scroll;
        max-height: 1050px;
        border-width: 1px;
        border-color: grey;
        border-style: solid;
        width: 1680px;
        margin: 10px;
    }
    .svgHeader {
        display: none;
    }
    select {
        margin: 10px;
    }
    table {
        margin: 10px;
    }
    table tr td {
        border-width: 1px;
        border-color: grey;
        border-style: solid;
    }
</style>

<body>
      <div>
        <h3>Normalisation parameters (play with it to find a nice fit for the game)</h3>
        <p>Introns are the non-coding parts of the gene (represented as the holes), which we could classify in 5 different classes for the game:</p>
        <ul>
            <li><label>small-intron is smaller than </label><input id="small-intron" type="number" value="5000">&nbsp;bps and normalized value is:<input id="small-intron-norm" type="number" value="1">units. With this type of intron we could say the avatar could easily jump.</li>
            <li><label>medium-intron is smaller than </label><input id="medium-intron" type="number" value="10000">&nbsp;bps and normalized value is:<input id="medium-intron-norm" type="number" value="5">units. With this type of intron we could say there are 1, 2 splicies (rocks) that the avatar need to jump on top to traverse the holw</li>
            <li><label>large-intron is smaller than </label><input id="large-intron" type="number" value="15000">&nbsp;bps and normalized value is:<input id="large-intron-norm" type="number" value="10">units. With this type of intron we could say that there is a spliceosome that moves</li>
            <li><label>big-intron is smaller than </label><input id="big-intron" type="number" value="20000">&nbsp;bps and normalized value is:<input id="big-intron-norm" type="number" value="20">units.  With this type of intron we could say that there is a spliceosome that moves and it is more complicated</li>
            <li><label>huge-intron is equal or bigger than </label><input id="huge-intron" type="number" value="20000">&nbsp;bps and normalized value is:<input id="huge-intron-norm" type="number"  value="50">units. With this type of intron there could be an SR protein before and the avatar would be propulsated (I think it is easy for the avatar)</li>
        </ul>
        <p>Exons (includes stop_codon, snp, start_codon) are relatively smallers (average is 500bps) compared to the introns (10000bps) and a continous normalisation approach was adopted:</p>
        <ul>
            <li><label>Division factor </label><input id="division-factor-exon" type="number" value="20">&nbsp; The length of the exons will be divided by this factor</li>
            <li><label>Minimal unit: </label><input id="minimal-unit" type="number" value="1">&nbsp; The exons will have in minimum this unit</li>
            <li><label>Maximal unit: </label><input id="maximal-unit" type="number" value="100">&nbsp; The exons will have in maximum this unit</li>
        </ul>
        <button onclick="loadProtein()" style="margin: 5px; font-size: 15px">Click here to normalize</button>
        Based on your parameters: Minimal units for the game are: <span id="minUnits" style="color:green">computing...</span>
        Maximal units for the game are: <span id="maxUnits" style="color:green">computing...</span>
    </div>
    <div>
        <h3>Notes</h3>
        <ul>
            <li>Up / Down / Obstacles are not yet defined (not sure if we should provide this info or we leave it up to you)....</li>
            <li>Intron are much bigger than exons in reality (if possible in the drawing of the blue lines could be a brin "enroule" to seem bigger...</li>
            <li>There is not a hole below the start, snp stop codon (it is a limitation of the library in use). It should be one exon with different color: from exon to utr (untranslated region)</li>
        </ul>
    </div>
    <div id="container">
      <div id="genes" style="width:1680px;height:1050px;padding:5px"></div>
    </div>
</body>


<script>
    loadProtein()

    function getBaseLog(x, y) {
        return Math.log(y) / Math.log(x);
    }
    
    function normalizeLength(levelData){
        
        if (levelData.type === "intron") {
            var normalizedIntron = getNormalizedLengthForIntrons(levelData.realLength);
            levelData.class = normalizedIntron.class
            levelData.normalizedLength = normalizedIntron.normalizedLength
        } else {
            var normalized = getNormalizedLengthForNonIntron(levelData.realLength);
            levelData.normalizedLength = normalized.normalizedLength
        }
        
    }

    function getNormalizedLengthForNonIntron(realLength) {

        var divisionFactor = parseInt($("#division-factor-exon").val())
        var minimalUnit = parseInt($("#minimal-unit").val())
        var maximalUnit = parseInt($("#maximal-unit").val())

        //Based on histogram in R
        //hist(log(exons$V6), breaks=5, col="lightgreen")
        var continousNormalization = Math.round(realLength / divisionFactor);
        if (continousNormalization > maximalUnit) {
            continousNormalization = maximalUnit;
        }
        if (continousNormalization < minimalUnit) {
            continousNormalization = minimalUnit;
        }
        

        return { normalizedLength: continousNormalization }

    };

    function getNormalizedLengthForIntrons(number) {

        //Based on histogram in R
        //hist(log(exons$V6), breaks=5, col="lightgreen")
        if (number < parseInt($("#small-intron").val()))
            return {
                class: "small-intron: The avatar can easily jump",
                normalizedLength: parseInt($("#small-intron-norm").val())
            } //simple jump --> most of them end up in this category
        if (number < parseInt($("#medium-intron").val()))
            return {
                class: "medium-intron: need an easy spliceosome, can be small 1,2 rocks that needs to jump",
                normalizedLength: parseInt($("#medium-intron-norm").val())
            } //mutiple jumps (kind of rocks) 
        if (number < parseInt($("#large-intron").val()))
            return {
                class: "large-intron: need a more complicated spliceosome",
                normalizedLength: parseInt($("#large-intron-norm").val())
            } //spliceosome
        if (number < parseInt($("#big-intron").val()))
            return {
                class: "big-intron: need a difficult spliceosome",
                normalizedLength: parseInt($("#big-intron-norm").val())
            } //Complicated spliceosome
        return {
            class: "huge-intron: we need a SR protein before, like a catapult",
            normalizedLength: parseInt($("#huge-intron-norm").val())
        } //SR protein (Catapult)
    };
    

    function renderGenes(genesInfo, genesData) {

        //Normalization and get max
        var maxNormalizedLength = 0;
        var minNormalizedLength = Number.MAX_SAFE_INTEGER;
        genesData.forEach(function (gene) {
            gene.totalNormalizedLength = 0
            gene.levelData.forEach(function (ld) {
                normalizeLength(ld);
                gene.totalNormalizedLength += ld.normalizedLength
            })
            var gi = genesInfo.filter(g => g.geneName === gene.geneName);
            gene.description = gi[0].description;

            maxNormalizedLength = Math.max(maxNormalizedLength, gene.totalNormalizedLength)
            minNormalizedLength = Math.min(minNormalizedLength, gene.totalNormalizedLength)
        })
        
        genesSorted = genesData.sort(function(a,b){
            if (a.totalNormalizedLength < b.totalNormalizedLength) {
                return -1;
            }else if (b.totalNormalizedLength < a.totalNormalizedLength) {
                return 1;
            }
            return 0;
        });


        genesSorted.forEach(function (gene) {

            $("#genes").append("<p style='font-size:12px'>" + 
                               "<br>Gene name: " + gene.geneName + " (links to neXtProt and UniProt)" +
                               "<br>Transcript: <a target='_blank' href='http://www.ensembl.org/Homo_sapiens/transview?db=core;transcript=" + gene.transcript + "'>" + gene.transcript + "</a>"+
                               "<br>Chromosome: " + gene.chromosome + 
                               "<br>Exons: " + gene.exonsCount + 
                               "<br>???% of protein coding (exons)" +
                               "<br>" + gene.geneLength + "bp   " + 
                               "<br>" + Math.ceil((gene.exonsLength + 1) / 3.0)  + "~aa (exonsLength / 3) but seems not to be correct" +
                               "<br>Text:" + gene.description + 
                               "<p>" + gene.totalNormalizedLength + "units<br>"+ 
                               "JSON:"
                              )
            
            $("#genes").append("<p style='font-size:8px'>" + JSON.stringify(gene, null, 2) + "</p>")
            $("#genes").append("<div id=\'" + gene.id + "\'></div>")
            $("#genes").append("<hr>")

            $("#maxUnits").text(maxNormalizedLength)
            $("#minUnits").text(minNormalizedLength)
            

            //Create a new Feature Viewer and add some rendering options
            var ft = new FeatureViewer(maxNormalizedLength, "#" + gene.id, {
                showAxis: true,
                showSequence: true,
                brushActive: true,
                toolbar: true,
                bubbleHelp: true,
                zoomMax: 10
            });

            var exonData = [];
            var intronData = [];
            var starsData = [];

            var cursor = 0;
            gene.levelData.forEach(function (ld) {
                
                var desc = ld.class ? ld.class : "" + "\n normalizedLength:" + ld.normalizedLength + "\n realLength:" + ld.realLength;
                var normalizedLength = ld.normalizedLength;
                if (ld.type === "exon" || ld.type === "utr") {
                    exonData.push({
                        "x": cursor,
                        "y": cursor + normalizedLength,
                        "description": desc,
                        "color": (ld.type == "exon") ? "green" : "lightgreen"
                    })
                } else if (ld.type === "intron") {
                    intronData.push({
                        "x": cursor,
                        "y": cursor + normalizedLength,
                        "description": desc,
                        "color": "blue"
                    })
                } else if (ld.type === "start_codon" || ld.type === "stop_codon" || ld.type === "snp") {
                    starsData.push({
                        "x": cursor,
                        "y": cursor + normalizedLength,
                        "description": desc,
                        "color": (ld.type == "snp") ? "red" : "orange",
                        "description": ld.type
                    })

                }
                cursor += normalizedLength
            })

            //Add some features
            ft.addFeature({
                data: starsData,
                name: "stars",
                type: "rect"
            });

            //Add some features
            ft.addFeature({
                data: exonData,
                name: "exons",
                type: "rect"
            });

            //Add some features
            ft.addFeature({
                data: intronData,
                name: "introns",
                type: "rect"
            });

        })


    }

    function loadProtein() {
        $("#maxUnits").text("computing...")
        $("#minUnits").text("computing...")
        $("#genes").empty();
        $.getJSON('data/genes.json', function (genesInfo) {
            $.getJSON('data/data.json', function (genesData) {
                renderGenes(genesInfo, genesData);
            })
        });
    }
</script>